<!DOCTYPE html>
<html>
<head>
  <title>Inventory Review</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f8fafc;
      margin: 0;
      padding: 0;
      color: #222;
    }
    h1 {
      color: #3366bb;
      margin-top: 30px;
      letter-spacing: 2px;
      font-size: 2rem;
    }
    .search-box {
      text-align: center;
      margin-bottom: 18px;
      margin-top: 18px;
    }
    #review-search {
      width: 210px;
      padding: 7px 14px;
      border: 1px solid #b4c4e0;
      border-radius: 7px;
      font-size: 1em;
      margin-right: 8px;
    }
    #review-search-btn {
      padding: 7px 22px;
      border: none;
      background: #4e77de;
      color: #fff;
      border-radius: 7px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.18s;
    }
    #review-search-btn:hover {
      background: #2848b6;
    }
    #main-card {
      background: #fff;
      max-width: 520px;
      margin: 32px auto 0 auto;
      border-radius: 10px;
      box-shadow: 0 4px 24px #26395911;
      padding: 32px 32px 16px 32px;
      text-align: center;
    }
    #nav {
      margin: 1.2em 0 1.2em 0;
      font-size: 1.1em;
    }
    #nav button {
      background: #e3eaff;
      color: #356acd;
      border: none;
      border-radius: 5px;
      font-size: 1.25em;
      margin: 0 8px;
      width: 40px;
      height: 40px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #nav button:hover {
      background: #b3c9fa;
    }
    #counter {
      margin: 0 10px;
      font-size: 1.08em;
      font-weight: 500;
    }
    #item-img {
      border-radius: 10px;
      max-width: 96%;
      box-shadow: 0 2px 10px #3764a340;
      margin-bottom: 25px;
    }
    #desc {
      font-size: 1.02em;
      margin-bottom: 8px;
      color: #446;
    }
    form {
      margin: 0 auto;
      text-align: left;
      display: inline-block;
      width: 90%;
      max-width: 420px;
    }
    textarea {
      font-family: inherit;
      width: 100%;
      padding: 10px;
      font-size: 1.03em;
      border: 1px solid #ced6e3;
      border-radius: 7px;
      margin: 12px 0 20px 0;
      min-height: 66px;
      background: #f6f8fa;
      resize: vertical;
      transition: border 0.2s;
    }
    textarea:focus {
      border: 1.5px solid #5471b7;
      outline: none;
      background: #e9f0fb;
    }
    .group {
      margin-bottom: 18px;
      padding: 7px 0;
      border-radius: 6px;
      background: #f8fafc;
    }
    .group span {
      display: block;
      font-size: 1.04em;
      font-weight: 600;
      color: #3366bb;
      margin-bottom: 5px;
    }
    .group label {
      margin-right: 1.2em;
      font-weight: 400;
      font-size: .99em;
      color: #404060;
      cursor: pointer;
    }
    #item-form button[type=submit] {
      background: #4d89e3;
      color: #fff;
      padding: 8px 30px;
      border: none;
      border-radius: 6px;
      font-size: 1.08em;
      cursor: pointer;
      margin: 15px auto 0 auto;
      display: block;
      transition: background 0.2s;
      box-shadow: 0 1px 6px #284d9a15;
    }
    #item-form button[type=submit]:hover {
      background: #2758b6;
    }
    #status {
      margin: 18px auto 0 auto;
      color: #369853;
      font-weight: 500;
      text-align: center;
      min-height: 1em;
    }
    @media (max-width: 540px) {
      #main-card { padding: 18px 2vw 6px 2vw; }
      form { width: 100%; }
      .search-box { margin-top: 8px; }
    }
  </style>
</head>
<body>
  <h1>Inventory Review</h1>
  <div class="search-box">
    <input id="review-search" type="text" placeholder="Jump/search by description, client...">
    <button type="button" id="review-search-btn">Find</button>
  </div>
  <div id="main-card">
    <div id="nav">
      <button id="prev" type="button">←</button>
      <span id="counter"></span>
      <button id="next" type="button">→</button>
    </div>
    <img id="item-img" src="" alt="Item Image"/>
    <div id="desc"></div>
    <form id="item-form" autocomplete="off">
      <textarea id="comments" placeholder="Add comments..."></textarea>
      <div class="group">
        <span>Type</span>
        <label><input type="checkbox" name="type" value="Furniture" id="type-furniture"> Furniture</label>
        <label><input type="checkbox" name="type" value="Chair" id="type-chair"> Chair</label>
        <label><input type="checkbox" name="type" value="Table" id="type-table"> Table</label>
        <label><input type="checkbox" name="type" value="Art" id="type-art"> Art</label>
        <label><input type="checkbox" name="type" value="Other" id="type-other"> Other</label>
      </div>
      <div class="group">
        <span>Disposition</span>
        <label><input type="checkbox" name="disposition" value="Sell" id="disposition-sell"> Sell</label>
        <label><input type="checkbox" name="disposition" value="Donate" id="disposition-donate"> Donate</label>
        <label><input type="checkbox" name="disposition" value="Toss" id="disposition-toss"> Toss</label>
      </div>
      <button type="submit">Save</button>
    </form>
    <div id="status"></div>
  </div>
  <script>
    let items = [];
    let idx = 0;

    // Checkbox radio group logic
    function singleCheckboxGroup(name) {
      const boxes = Array.from(document.querySelectorAll(`input[name=${name}]`));
      boxes.forEach(box => {
        box.addEventListener('change', function() {
          if (this.checked) {
            boxes.forEach(b => { if (b !== this) b.checked = false; });
          }
        });
      });
    }
    window.addEventListener("DOMContentLoaded", function() {
      singleCheckboxGroup("type");
      singleCheckboxGroup("disposition");
    });

    function show(i) {
      if (!items.length || !items[i]) {
        document.getElementById('counter').textContent = 'No items';
        document.getElementById('item-img').src = '';
        document.getElementById('desc').textContent = '';
        document.getElementById('comments').value = '';
        document.querySelectorAll('input[name=type]').forEach(cb => cb.checked = false);
        document.querySelectorAll('input[name=disposition]').forEach(cb => cb.checked = false);
        document.getElementById('status').textContent = '';
        return;
      }
      const x = items[i];
      document.getElementById('counter').textContent = `Item ${i+1} / ${items.length}`;
      document.getElementById('item-img').src = x.image_file || x.image_url || '';
      document.getElementById('desc').textContent = (x.description || '') + ' — ' + (x.client || '');
      document.getElementById('comments').value = x.comments || '';
      document.querySelectorAll('input[name=type]').forEach(cb => {
        cb.checked = (x.type === cb.value);
      });
      document.querySelectorAll('input[name=disposition]').forEach(cb => {
        cb.checked = (x.disposition === cb.value);
      });
      document.getElementById('status').textContent = '';
    }

    function saveCurrent(callback) {
      if (!items.length) return;
      const item = items[idx];
      const comments = document.getElementById('comments').value;
      const type = Array.from(document.querySelectorAll('input[name=type]'))
        .find(cb => cb.checked)?.value || '';
      const disposition = Array.from(document.querySelectorAll('input[name=disposition]'))
        .find(cb => cb.checked)?.value || '';
      fetch('/api/item/' + item.id, {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({comments, type, disposition}),
      })
      .then(res => res.json())
      .then(d => {
        item.comments = comments;
        item.type = type;
        item.disposition = disposition;
        document.getElementById('status').textContent = "Saved!";
        if(callback) callback();
      });
    }

    document.getElementById('item-form').onsubmit = function(e) {
      e.preventDefault();
      saveCurrent();
    };
    document.getElementById('next').onclick = function() {
      if (items.length && idx < items.length-1) {
        saveCurrent(() => { idx++; show(idx); });
      }
    };
    document.getElementById('prev').onclick = function() {
      if (items.length && idx > 0) {
        saveCurrent(() => { idx--; show(idx); });
      }
    };
    document.addEventListener('keydown', function(e) {
      const el = document.activeElement;
      if(el && (el.tagName === "TEXTAREA" || (el.tagName === "INPUT" && el.type === "text"))) return;
      if(e.key === 'ArrowRight') document.getElementById('next').onclick();
      if(e.key === 'ArrowLeft') document.getElementById('prev').onclick();
    });

    // Search/jump feature
    document.getElementById('review-search-btn').onclick = function() {
      const q = document.getElementById('review-search').value.toLowerCase().trim();
      if (!q) return;
      const found = items.findIndex(x =>
        (x.description||'').toLowerCase().includes(q) ||
        (x.client||'').toLowerCase().includes(q) ||
        (x.id+"").toLowerCase().includes(q)
      );
      if (found > -1) {
        saveCurrent(() => { idx = found; show(idx); });
        document.getElementById('status').textContent = "Matched item " + (found+1) + " of " + items.length;
      } else {
        document.getElementById('status').textContent = "No match found.";
      }
    };
    document.getElementById('review-search').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') document.getElementById('review-search-btn').onclick();
    });

    // Load items on page load
    fetch('/api/items').then(r=>r.json()).then(data=>{
      items = data;
      idx = 0;
      show(idx);
    });
  </script>
</body>
</html>
